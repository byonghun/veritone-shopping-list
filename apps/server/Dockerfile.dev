# What is Docker
# A Docker image is like a snapshot of an OS + tools + your app.
# A container is a running instance of that image.
# This Dockerfile builds a development image for a Node/Express app that runs npm run dev (using tsx watch) so code changes reload automatically.

# Dev-only Dockerfile for Node.js/Express with hot reload (tsx)
# By default, containers run as root. For safety, we create a non-root user app.
# Use alpine for its small bundle size
FROM node:22-alpine3.22

# Prevent husky hook installation during docker build
ENV HUSKY=0

# (Optional but recommended) pull latest security fixes for base packages
# Install openssl and psql
RUN apk -U --no-cache upgrade && apk add --no-cache openssl postgresql-client

# create non-root user
RUN addgroup -S app && adduser -S app -G app
WORKDIR /workspace

# Copy manifests first for better layer caching
# Cache-friendly install for workspaces
COPY package.json package-lock.json ./
COPY shared/package.json shared/package.json
COPY apps/server/package.json apps/server/package.json
# Install ONLY the needed workspaces (shared + server)
# RUN npm ci -w @app/shared -w @app/server

RUN npm ci

# Copy the full repo (monorepo-friendly)
COPY . .
WORKDIR /workspace/apps/server
RUN npx prisma generate

# Ensure non-root can access everything
WORKDIR /workspace
RUN chown -R app:app /workspace

USER app
EXPOSE 3001
CMD ["npm", "run", "dev"]
